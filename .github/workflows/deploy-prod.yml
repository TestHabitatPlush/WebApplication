name: Deploy to Production (Manual)

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type DEPLOY to confirm production deployment'
        required: true
        default: ''

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DEPLOY" ]; then
            echo "❌ Deployment cancelled - confirmation code incorrect"
            exit 1
          fi
          echo "✅ Production deployment confirmed!"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # SERVICE (Backend) - Production
      - name: Install Service Dependencies
        working-directory: ./service
        run: npm ci

      # WEB (Frontend) - Production
      - name: Install Web Dependencies
        working-directory: ./web
        run: npm ci

      - name: Build Web (Production)
        working-directory: ./web
        run: npm run build
        env:
          NODE_ENV: production

      # ADMIN (Admin Panel) - Production
      - name: Install Admin Dependencies
        working-directory: ./admin
        run: npm ci

      - name: Build Admin (Production)
        working-directory: ./admin
        run: npm run build
        env:
          NODE_ENV: production

      # Deploy to Hostinger (Production Server)
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "⚠️  STARTING PRODUCTION DEPLOYMENT..."
            
            cd /var/www/habitat-plush
            
            # Pull latest code
            git fetch origin
            git checkout master
            git reset --hard origin/master
            
            echo "Deploying Service (Backend)..."
            cd service
            npm ci
            pm2 reload habitat-service-prod --env production || pm2 start app.js --name "habitat-service-prod" --env production
            
            echo "Deploying Web (Frontend)..."
            cd ../web
            npm ci
            npm run build
            pm2 reload habitplus-web-prod --env production || pm2 start "npm start" --name "habitplus-web-prod" --env production
            
            echo "Deploying Admin (Admin Panel)..."
            cd ../admin
            npm ci
            npm run build
            pm2 reload habitplus-admin-prod --env production || pm2 start "npm start" --name "habitplus-admin-prod" --env production
            
            pm2 save
            echo "✅ Production deployment successful!"

      - name: Deployment Success
        if: success()
        run: echo "✅ Production deployment completed successfully!"

      - name: Deployment Failed
        if: failure()
        run: echo "❌ Production deployment failed - check logs above"