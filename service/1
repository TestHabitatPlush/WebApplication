const path = require('path');
const express = require("express");
const cors = require("cors");
const bodyParser = require("body-parser");
const cookieParser = require("cookie-parser");
const dotenv = require("dotenv");

// Load env variables based on NODE_ENV
dotenv.config({ path: path.resolve(__dirname, `env/.env.${process.env.NODE_ENV}`) });

// Initialize express app
const app = express();

// Middlewares
app.use(express.json());
app.use(cookieParser());
app.use(cors());
app.use(bodyParser.json());

// Static folder
app.use("/uploads", express.static(path.join(__dirname, "uploads")));

// Route imports
const errorHandler = require("./middleware/errorHandler");
const userRouter = require("./routes/userRoutes");
const familyRouter = require("./routes/userFamilyRoutes.js");
const authRouter = require("./routes/authRoutes");
const documentRouter = require("./routes/documentRoutes");
const discussionRouter = require("./routes/discussion_forum_Routes");
const jobProfileRouter = require("./routes/jobProfileRoutes");
const customerRoutes = require("./routes/customerRoutes");
const parkingRoutes = require("./routes/parkingRoutes");
const emergencyContactRouter = require("./routes/emergency_contact_Routes");
const gateAllocationRoutes = require("./routes/gateAllocationRoutes.js");
const locationRouter = require("./routes/locationRoutes");
const subscriptionPlanRoutes = require("./routes/subscriptionPlanRoutes");
const roleRouter = require("./routes/roleRoutes");
const adminRouter = require("./routes/adminRoutes");
const buildingRouter = require("./routes/buildingRoutes");
const filterRoutes = require("./routes/filterRoutes");
const floorRouter = require("./routes/floorRoutes");
const unitTypeRouter = require("./routes/unitTypeRoutes");
const gateRouter = require("./routes/gateRouter");
const refUserGroupRouter = require("./routes/refUserGroupRouter");
const noticeAnnouncementRouter = require("./routes/noticeAnnouncementRouter");
const visitorManagementRouter = require("./routes/visitorManagementRouter");
const unitRouter = require("./routes/unitRoutes");
const softwareHelpDeskRouter = require("./routes/softwareHelpDeskRouter");
const refTicketStatusRouter = require("./routes/refTicketStatusRouter");
const passwordRouter = require("./routes/passwordRoutes.js");
const facilityManagement = require("./routes/facilityManagementRoutes");

// Init controller
const { initController } = require("./auto-creating-handlers");

// Test routes
app.get("/", (req, res) => {
  res.send("API is working fine !");
});
app.get("/getenv", (req, res) => {
  res.send(`Your current environment is ${process.env.NODE_ENV}`);
});

// API Routes
app.use("/api/users", userRouter);
app.use("/api/family", familyRouter);
app.use("/api/password", passwordRouter);
app.use("/api/auth", authRouter);
app.use("/api", customerRoutes);
app.use("/api", subscriptionPlanRoutes);
app.use("/api/role", roleRouter);
app.use("/api/admin", adminRouter);
app.use("/api/gate", gateRouter);
app.use("/api/gateAllocation", gateAllocationRoutes);
app.use("/api/building", buildingRouter);
app.use("/api/floor", floorRouter);
app.use("/api/unitType", unitTypeRouter);
app.use("/api/unit", unitRouter);
app.use("/api/jobProfile", jobProfileRouter);
app.use("/api/refusergroup", refUserGroupRouter);
app.use("/api/noticeAnnouncement", noticeAnnouncementRouter);
app.use("/api/visitormanagement", visitorManagementRouter);
app.use("/api/softwarehelpdesk", softwareHelpDeskRouter);
app.use("/api/softwarehelpdesk", refTicketStatusRouter); // Assuming this is intentional
app.use("/api/filter", filterRoutes);
app.use("/api/facilityManagement", facilityManagement);
app.use("/api", parkingRoutes);
app.use("/api/documents", documentRouter);
app.use("/api/discussionForum", discussionRouter);
app.use("/api/emergencyContacts", emergencyContactRouter);
app.use("/api/location", locationRouter);

// Init DB
app.get("/init-database", initController);

// Error handler
app.use(errorHandler);

module.exports = app;

